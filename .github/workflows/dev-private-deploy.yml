name: Dev Private Deploy

on:
  push:
    branches-ignore:
      - 'gh-pages'  # 忽略非代码分支

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host

      - name: Log in to Private Registry (Manual)
        env:
          REGISTRY_USER: ${{ secrets.PRIVATE_REGISTRY_USERNAME }}
          REGISTRY_PWD: ${{ secrets.PRIVATE_REGISTRY_PASSWORD }}
        run: |
          echo "$REGISTRY_PWD" | docker login docker.topren.top -u "$REGISTRY_USER" --password-stdin

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: docker.topren.top/claude-relay-service
          # 生成两种 tag:
          # 1. 分支名 (例如: dev, fix-bug) - 总是指向该分支最新代码
          # 2. commit hash (例如: sha-7b3f1a2) -用于回溯历史版本
          tags: |
            type=ref,event=branch
            type=sha,format=short,prefix=dev-

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 新增步骤：处理分支名，将 / 替换为 - 以适配 Docker Tag 规范
      - name: Sanitize Branch Name
        id: branch_name
        run: |
          # 获取原始分支名
          RAW_BRANCH="${{ github.ref_name }}"
          # 将 / 替换为 -
          SANITIZED_BRANCH="${RAW_BRANCH//\//-}"
          echo "Original: $RAW_BRANCH"
          echo "Sanitized: $SANITIZED_BRANCH"
          echo "tag=$SANITIZED_BRANCH" >> $GITHUB_OUTPUT

      # 远程执行部署命令
      # 注意：不再上传 docker-compose.yml，避免覆盖服务器的 JWT_SECRET/ENCRYPTION_KEY 配置
      - name: SSH Remote Deploy
        uses: appleboy/ssh-action@master
        env:
          PRIVATE_REGISTRY_USERNAME: ${{ secrets.PRIVATE_REGISTRY_USERNAME }}
          PRIVATE_REGISTRY_PASSWORD: ${{ secrets.PRIVATE_REGISTRY_PASSWORD }}
          # 使用处理后的 Tag
          IMAGE_TAG: ${{ steps.branch_name.outputs.tag }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          envs: PRIVATE_REGISTRY_USERNAME,PRIVATE_REGISTRY_PASSWORD,IMAGE_TAG
          script: |
            # 1. 登录私有仓库 (确保服务器也能访问)
            echo "$PRIVATE_REGISTRY_PASSWORD" | docker login docker.topren.top -u "$PRIVATE_REGISTRY_USERNAME" --password-stdin

            # 2. 进入目录
            cd /root/docker

            # 3. 设置镜像名环境变量
            export DOCKER_IMAGE_NAME="docker.topren.top/claude-relay-service:${IMAGE_TAG}"
            echo "Deploying image: $DOCKER_IMAGE_NAME"

            # 4. 拉取并重启
            # -E 保持环境变量传给 sudo (如果 docker 需要 sudo)
            # 如果是 root 用户直接运行，不需要 sudo
            docker-compose pull
            docker-compose up -d

            # 5. 清理旧镜像 (可选，释放空间)
            docker image prune -f
